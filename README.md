# Лабораторная №1

**Цель работы:**
Запустить приложение при помощи ansible, научиться писать плейбуки и пользоваться group vars

Docker-образ: https://hub.docker.com/repository/docker/timurbabs/django

Универсальный файл для вагранта: Vagrantfile

**Ход работы:**
1.	Установить Ansible используя (Гайд по установке)
2.	Установить Vagrant (Гайд по установке)
3.	Поднять Vagrant хост из ссылки при помощи файла Vagrantfile используя команду *vagrant up (VagrantFile)
4.	Написать inventory-файл для развернутых хостов
5.	Написать плейбук для установки Docker
6.	Клонировать репо (Репозиторий) на ноды группы [app]
7.	Запустить приложение на нодах группы [app] используя ansible


## Шаг 1: Установка Ansible

Установили Homebrew при помощи команды

/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

Далее устанавливаем ansible
brew install ansible

## Шаг 2: Установка Vagrant 

brew install --cask vagrant

## Шаг 3: Поднять Vagrant хост из ссылки при помощи файла Vagrantfile используя команду *vagrant up 

Подключились с наших mac к удаленному bastion серверу, использующий образ ubuntu, при помощи публичного ssh-ключа, скопированного ранее на сервер:
ssh -p2228 viktoria@94.26.228.63
Создали отдельную директорию для vagrant:
mkdir vagrant
cd vagrant

Разместили конфигурационный файл Vagrantfile, который используется для настройки и запуска виртуальных машин, в ранее созданной директории. 
В файле опередили базовый образ ubuntu/focal64, цикл для создания трех виртуальных машин и назначили им IP-адреса 192.168.56.11, 192.168.56.12, и 192.168.56.13. 
В качестве провайдера указываем virtualbox, а объем памяти для каждой виртуальной машины — 512МБ.
При помощи встроенного скрипта shell происходит чтение ssh-ключа по указанному адресу и открытый ssh-ключ ключ добавляется в файл authorized_keys для пользователей vagrant и root, что позволяет подключаться по ssh без пароля

![image](https://github.com/user-attachments/assets/7359c8bb-34bf-4434-9700-a8cd533b6db9)


В эту же директорию также разместим скаченный с гугл диска образ ubuntu
![image](https://github.com/user-attachments/assets/b00ae944-9976-4aa2-b60c-51d84e3a0f81)

Выполнили команду для добавления нового vagrant-бокса:
vagrant box add ./focal-server-cloudimg-amd64-vagrant.box --name ubuntu/focal64

Запустим виртуальную машину при помощи команды: vagrant up
![image](https://github.com/user-attachments/assets/5efd64a1-2fbb-47a6-88c5-044d0cf9265f)
![image](https://github.com/user-attachments/assets/8459b363-a544-4e82-95c8-1599d333e0a0)



## Шаг 4: Написать inventory-файл для развернутых хостов
Напишем inventory.yml для указания, с какими серверами он должен взаимодействовать

## Шаг 5 и 6: Написать плейбук для установки Docker, клонировать репо на ноды группы [app]
Создаем файл docker-install.yml для того, чтобы задать инструкции для автоматического выполнения на целевом сервере, в нашем случае для установки docker на нескольких серверах быстро и одинаково

В файле мы задали следующие таски: обновление списков пакетов и обновление установленных пакетов на каждом узле, установка необходимых зависимостей для docker, добавлени GPG-ключа для того, чтобы убедиться в подлинности пакетов, которые будут устанавливаться, добавление официального репозитория Docker для получения актуальных версий Docker Engine, Установка Docker Engine на каждый узел, установка git, клонирование репозитория с приложением на каждый узел, загрузка docker-образа из репозитория docker hub и запуск docker-контейнера на каждом узле с использованием загруженного образа.

Создаем файлы конфигурации для упрощения ssh-подключений к серверам, т.к. у нас есть промежуточный хост, через который нужно пробрасывать подключения

## Шаг 7:
И запускаем приложение на нодах - ansible-playbook -i inventory.yml docker-install.yml
![image](https://github.com/user-attachments/assets/26b537f3-99bf-4086-ad55-f8d3ab4d7bc9)
![image](https://github.com/user-attachments/assets/a3b1abdf-6375-4c06-beef-20496b205ef1)

Далее подключаемся к первой ноде
ssh -F config node1
 ![image](https://github.com/user-attachments/assets/6cc347a9-9b9f-4388-8a45-002bb53a4ea3)


Проверяем список запущенных контейнеров в докер
 ![image](https://github.com/user-attachments/assets/abbf520c-8436-4499-99f4-94d1bdd18fe1)


